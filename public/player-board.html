<!-- The ‚Äúfirst player not saving‚Äù bug is caused by a race between separate clear/set calls.
Fix by making the backend route atomic and sending only one request per radio click.
With this change, the unicorn tag will stick correctly for the first player as well as others.
 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player Dashboard ‚Äî Udderly the Same</title>
  <!-- Socket.IO client library connects browser to server in real time -->
  <script src="/socket.io/socket.io.js"></script>

<style>
/* ---------------- General Page Styling ---------------- */
body {
  font-family:'Segoe UI',Arial,sans-serif;   /* Sets the font family for the whole page */
  max-width:900px;                           /* Restricts page width so it doesn‚Äôt stretch too wide */
  margin:30px auto;                          /* Adds space around the page and centers it horizontally */
  background:linear-gradient(135deg,#fdfcfb,#e2d1c3); /* Soft gradient background for visual appeal */
  padding:20px;                              /* Adds space inside the body container */
  border-radius:12px;                        /* Rounds the corners of the page container */
  box-shadow:0 4px 12px rgba(0,0,0,0.1);     /* Adds a subtle shadow for depth */
}

/* ---------------- Header Section ---------------- */
.header {
  display:flex;                              /* Use flexbox to arrange items horizontally */
  align-items:center;                        /* Vertically center items within the header */
  gap:12px;                                  /* Adds spacing between logo and title */
  margin-bottom:20px;                        /* Adds space below the header */
}
.logo { max-width:100px; height:auto; display:block; }
h2 { margin:0; }

/* ---------------- Status Message ---------------- */
#statusMessage {
  font-weight:bold; margin-top:10px; text-align:center; color:#444;
}

/* ---------------- Buttons ---------------- */
button {
  padding:10px 18px; margin:6px; font-size:16px; border:none; border-radius:8px;
  cursor:pointer; background:#333; color:#fff; transition:background 0.3s ease;
}
button:disabled { background:#999; cursor:not-allowed; }
button:hover:enabled { background:#F7AC4D; }

.danger-btn:hover:enabled { background:#d32f2f; color:#fff; font-weight:bold; }
#showQuestionBtn:hover:enabled { background:#1976d2; }
#showAnswersBtn:hover:enabled { background:#2e7d32; }

#signOutBtn {
  background-color: #d32f2f; color: white; border: none; padding: 10px 18px;
  border-radius: 6px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;
}
#signOutBtn:hover { background-color: #ffa600; }

/* ---------------- Accordion Styling ---------------- */
.accordion { margin-top:20px; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.accordion-header { background:#333; color:#fff; padding:12px; cursor:pointer; font-weight:bold; }
.accordion-header:hover { background:#F7AC4D; }
.accordion-content { max-height:0; overflow:hidden; transition:max-height 0.4s ease; background:#fff; padding:0 15px; }
.accordion-content.open { padding:15px; max-height:1500px; }


/* ---------------- auto‚Äësizing to content ---------------- 
.accordion-content.open {
  padding:15px;
  max-height:none;   /* let it size naturally */
}
*/

	

#qaSection {
  display: flex;
  flex-direction: column; /* stack children vertically */
  gap: 10px;              /* space between textarea and button */
}

#answerInput {
  width: 100%;            /* full width of parent */
  min-height: 100px;      /* taller box for typing */
  padding: 10px;
  font-size: 16px;
  box-sizing: border-box; /* include padding in width calculation */
}

#submitAnswerBtn {
  align-self: flex-start; /* button aligns left; use center if preferred */
  padding: 10px 20px;
  font-size: 16px;
}

	

/* ---------------- Pivot Table Styling ---------------- */
#pivotTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
}

#pivotTable th,
#pivotTable td {
  border: 1px solid #ddd;
  padding: 8px;
}

/* First column: small, just enough for checkbox */
#pivotTable th:first-child,
#pivotTable td:first-child {
  width: 40px;          /* narrow column */
  text-align: center;   /* center checkbox */
}

/* Second column: fixed width for 2-digit numbers */
#pivotTable th:nth-child(2),
#pivotTable td:nth-child(2) {
  width: 50px;          /* enough for 00‚Äì99 */
  text-align: center;   /* center counts */
  font-weight: bold;
}

/* Third column: answer text takes remaining space */
#pivotTable th:nth-child(3),
#pivotTable td:nth-child(3) {
  width: auto;
  text-align: left;
}

/* Header styling */
#pivotTable th {
  background-color: #333;
  color: #fff;
  font-weight: bold;
}

/* Alternating row colors */
#pivotTable tr:nth-child(even) {
  background-color: #f9f9f9;
}

#pivotTable tr:nth-child(odd) {
  background-color: #ffffff;
}

/* Row hover effect */
#pivotTable tr:hover {
  background-color: #e6f2ff;
}

/* Make checkboxes bigger */
#pivotTable input[type="checkbox"] {
  transform: scale(1.5);   /* enlarge checkbox */
  margin: 4px;             /* spacing */
  cursor: pointer;
}
	
/* ---------------- Table Styling ---------------- */

#answersTable, #playersTable, #scoreTable {
  font-size:18px; border-collapse:collapse; width:100%; margin-top:10px;
}
#answersTable th, #answersTable td,
#playersTable th, #playersTable td,
#scoreTable th, #scoreTable td {
  border-bottom:1px solid #ccc; padding:8px;
}
#answersTable th { text-align:left !important; }
#playersTable th { text-align:left !important; }

/* ---------------- Scroll Wrappers ---------------- */
.scroll-wrapper {
  max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px;
}
.table-wrapper {
  overflow-x: auto; overflow-y: auto; max-height: 400px; width: 100%;
  border: 1px solid #ccc; border-radius: 6px;
}

/* ---------------- Popup Modal ---------------- */
.popup {
  display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center;
}
.popup-content {
  background:#fff; border-radius:16px; padding:40px; width:80%; max-width:700px;
  text-align:center; box-shadow:0 8px 24px rgba(0,0,0,0.3); animation:fadeIn 0.4s ease; position:relative;
}
.popup-content h1 { font-size:2rem; color:#333; margin:0; }
.close-btn { position:absolute; top:20px; right:30px; font-size:32px; font-weight:bold; color:#333; cursor:pointer; transition:color 0.3s; }
.close-btn:hover { color:#F7AC4D; }
@keyframes fadeIn { from { transform:scale(0.9); opacity:0; } to { transform:scale(1); opacity:1; } }

/* ---------------- Game Over Banner ---------------- */
#gameOverBanner {
  background-color: #d32f2f; color: white; font-weight: bold; text-align: center;
  padding: 25px; font-size: 22px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.hidden { display: none; }

/* ---------------- Scoreboard Table ---------------- */
#scoreTable { table-layout: fixed; border-collapse: collapse; width: 100%; }
#scoreTable th, #scoreTable td { padding: 6px; white-space: nowrap; border: 1px solid #ccc; }
#scoreTable th:first-child, #scoreTable td:first-child { text-align: left; width: 40px; position: sticky; left: 0; background: #fff; z-index: 3; }
#scoreTable th:nth-child(2), #scoreTable td:nth-child(2) { text-align: left; padding-left: 10px; width: 150px; position: sticky; left: 40px; background: #fff; z-index: 3; }
#scoreTable th:nth-child(3), #scoreTable td:nth-child(3) { text-align: center; width: 80px; position: sticky; left: 190px; background: #fff; border-right: 2px solid #999; box-shadow: 1px 0 0 #999; z-index: 3; }
#scoreTable th:nth-child(n+4), #scoreTable td.roundCell { text-align: center; width: 55px; }
.scoreSelect { width: 100%; text-align: center; }

/* ---------------- Answers table inline toggle styling ---------------- */
/* Switch container inside answers table */
#answersTable .switch {
  position: relative;                        /* Container for the slider and label */
  display: inline-block;                     /* Lets it sit inline inside the cell */
  width: 80px; height: 32px;                 /* Pill size */
}
/* Hide the raw checkbox; we style the sibling .slider instead */
#answersTable .switch input { display: none; }

/* The pill track for the toggle (OFF by default) */
#answersTable .slider {
  position: relative;                        /* Positions inside switch container */
  width: 100%; height: 100%;
  background-color: #ddd;                    /* Gray pill background when OFF */
  border: 2px solid #aaa;                    /* Subtle border around pill */
  border-radius: 32px;                       /* Rounded ends for pill shape */
  transition: background-color 0.3s, border-color 0.3s; /* Smooth transitions */
  cursor: pointer;                           /* Pointer cursor on hover */
}

/* The knob uses an emoji; we animate translateX on check */
#answersTable .slider::before {
  content: "üèÖ";                              /* Emoji inside knob when OFF */
  position: absolute; width: 28px; height: 28px; left: 2px; top: 2px;
  background-color: white;                   /* White knob */
  border: none;                              /* No border around knob */
  display: flex; align-items: center; justify-content: center; font-size: 18px;
  transition: transform 0.3s, background-color 0.3s, content 0.3s; /* Smooth animations */
}

/* When checkbox is checked, make pill green and slide knob right */
#answersTable .switch input:checked + .slider {
  background-color: #66bb6a;                 /* Green when ON */
  border-color: #66bb6a;                     /* Match border to background */
}
#answersTable .switch input:checked + .slider::before {
  transform: translateX(48px);               /* Move knob to right */
  content: "üèÉ‚Äç‚ôÄÔ∏è";                           /* Change emoji when ON */
}

/* Labels next to toggles to show "+1" or "0" with color */
.pointLabel { margin-left: 6px; font-weight: bold; }
.pointLabel.green { color: #2e7d32; }        /* Green text for +1 */
.pointLabel.blue  { color: #1976d2; }        /* Blue text for 0 */

/* Unicorn radio custom circle */
.unicornRadio { display: none; }              /* Hide the native radio */
.unicornLabel {
  width: 24px; height: 24px; border: 2px solid #afc; border-radius: 50%;
  display: inline-block; position: relative; cursor: pointer; transition: all 0.3s ease;
}
.unicornLabel:hover { border-color: #888; box-shadow: 0 0 6px rgba(0,0,0,0.5); }
.unicornRadio:checked + .unicornLabel::after {
  content: "ü¶Ñ"; font-size: 18px; position: absolute; top: -2px; left: -2px;
}
</style>
</head>
<body>
  <!-- ---------------- Header ---------------- -->
  <div class="header">
    <img src="udderly-logo-main-b.png" alt="Udderly the Same Logo" class="logo">
    <h2>üêÆ Player Dashboard <span class="small">(code ver. 1.2.0r)</span></h2>
    <button id="endGameBtn" class="danger-btn" style="margin-left:auto;">End Game</button>
  </div>

  <!-- Game Over Banner -->
  <div id="gameOverBanner" class="hidden">üéÆ Game Over</div>

  <!-- Players Accordion -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('playersBox')">Players</div>
    <div id="playersBox" class="accordion-content open">
      <div class="scroll-wrapper">
        <table id="playersTable">
          <thead><tr><th>Player</th><th>Out</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Game Room Info Accordion -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('questionBox')">Game Room Info</div>
    <div id="questionBox" class="accordion-content open">
      <div class="roomHeader">
        <p id="roomLabel"></p>
        <span id="topStatus"></span>
      </div>
      <div id="controls">
        <button id="startBtn">Start Round</button>
        <button id="showQuestionBtn">Show Question</button>
        <button id="showAnswersBtn" disabled>Show Answers</button>
        <p id="statusMessage"></p>
      </div>
		<div id="qaSection" style="display:none;">
		  <p id="questionPrompt"></p>
		  <textarea id="answerInput" rows="4" placeholder="Type your answer..."></textarea>
		  <button id="submitAnswerBtn">Submit Answer</button>
		  <p id="progress"></p>
		</div>
    </div>
  </div>

<!-- Pivot Counts Accordion -->
<!-- This accordion shows grouped answers with counts and multi-checkboxes.
   Check multiple answers to award +1 to everyone who submitted those answers. -->
<!-- Pivot Counts Accordion -->
<div id="pivotAccordion" class="accordion">
  <div class="accordion-header" onclick="toggleAccordion('pivotTableWrapper')">Pivot Counts</div>


<div id="pivotTableWrapper" class="accordion-content">

		<button id="loadPivotBtn">Load Pivot from Server</button>
	
	<div class="scroll-wrapper">
	  <table id="pivotTable">
		<thead>
		  <tr><th>Select</th><th>Count</th><th>Answer</th></tr>
		</thead>
		<tbody></tbody>
	  </table>
	</div>
  </div>
</div>


  <!-- Answers Accordion -->
  <div id="answersAccordion" class="accordion" style="display:none;">
    <div class="accordion-header" onclick="toggleAccordion('answersTableWrapper')">Answers</div>
    <div id="answersTableWrapper" class="accordion-content">
      <div id="answersHeader" class="mb-2">
        <strong>Round <span id="roundNumber"></span>:</strong>
        <span id="questionText"></span>
      </div>
      <div class="scroll-wrapper">
        <table id="answersTable">
          <thead>
            <tr>
              <th>Point</th>
              <th>TAG</th>
              <th>Name</th>
              <th>Answer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Scoreboard Accordion -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('scoreboardBox')">Scoreboard</div>
    <div id="scoreboardBox" class="accordion-content">
      <div class="table-wrapper">
        <button id="editScoreboardBtn">Edit Scores</button>
        <table id="scoreTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Control Switches Accordion -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('controlsBox')">Control switches</div>
    <div id="controlsBox" class="accordion-content">
      <div class="controlsLayout" style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px;">
        <div class="leftColumn" style="display:flex; flex-direction:column; gap:12px;">
          <div class="switch"><label><input type="checkbox" id="toggleStart" checked><span class="slider"></span>Enable Start Round</label></div>
          <div class="switch"><label><input type="checkbox" id="toggleShow" checked><span class="slider"></span>Enable Show Answers</label></div>
          <div class="switch"><label><input type="checkbox" id="toggleSubmit" checked><span class="slider"></span>Enable Submit Answer</label></div>
        </div>
        <div class="middleColumn" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
          <div class="switch">
            <label>
              <input type="checkbox" id="toggleUnicorn">
              <span class="slider"></span>Enable Unicorn Control
            </label>
          </div>
          <button id="clearUnicornBtn" style="display:none;">Clear Unicorn</button>
        </div>
        <div class="rightColumn" style="display:flex; align-items:center; align-self:stretch;">
          <button id="signOutBtn">Sign Out</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="roundPopup" class="popup">
    <div class="popup-content">
      <span id="closePopup" class="close-btn">&times;</span>
      <h1 id="popupQuestion"></h1>
    </div>
  </div>

  <!-- Disclaimer Footer -->
  <div class="disclaimer" style="text-align:center; font-size:0.75em; color:#666; margin-top:50px;">
    This online game is inspired by Herd Mentality, created by Big Potato Games.
    It is an independent project and is not affiliated with, endorsed by, or sponsored by Big Potato Games.
  </div>

  <!-- ---------------- JavaScript Section ---------------- -->
  <script>
    /* ---------------- Global flags and URL params ---------------- */
    let roomIsClosed = false;                 // tracks if server closed the room
    let answersShown = false;                 // tracks if answers are currently revealed
    let currentRound = 0;                     // latest round number; updated on roundStarted
    let scoreboard = [];                      // latest scoreboard from server
    let lastAnswers = [];                     // cache of answers rows for current round (used by Pivot awarding)

    const urlParams = new URLSearchParams(window.location.search);
    const roomCode  = (urlParams.get("room")  || "").toUpperCase();
    const myName    = (urlParams.get("name")  || "");
    const themeCode = (urlParams.get("theme") || "").toUpperCase();

    /* ---------------- DOM references ---------------- */
    const startBtn      = document.getElementById("startBtn");
    const showBtn       = document.getElementById("showAnswersBtn");
    const showQuestionBtn = document.getElementById("showQuestionBtn");
    const statusMessage = document.getElementById("statusMessage");
    const submitBtn     = document.getElementById("submitAnswerBtn");
    const inputBox      = document.getElementById("answerInput");
    const endGameBtn    = document.getElementById("endGameBtn");
    const signOutBtn    = document.getElementById("signOutBtn");

    /* ---------------- Utility functions ---------------- */
    // Escape HTML to prevent injection attacks
    function escapeHTML(str){
      const div=document.createElement('div');
      div.innerText=String(str||"");
      return div.innerHTML;
    }
    // Accordion helpers
    function toggleAccordion(id){document.getElementById(id).classList.toggle("open");}
    function openAccordion(id){document.getElementById(id).classList.add("open");}
    function closeAccordion(id){document.getElementById(id).classList.remove("open");}
    // Map scoreboard data to round points for quick lookup
    function toRoundMap(data, round) {
      const map = {};
      (data || []).forEach(d => {
        const val = (d.rounds && d.rounds[round]) != null ? d.rounds[round] : 0;
        map[escapeHTML(d.player_name)] = parseInt(val, 10) === 1 ? 1 : 0;
      });
      return map;
    }

    /* ---------------- Connect to server ---------------- */
    const socket = io();
    // Show greeting and room
    document.getElementById("roomLabel").innerText = `Room: ${escapeHTML(roomCode)} ‚Äî Hello: ${escapeHTML(myName)}`;
    // Join lobby: lets server track you in the room and send updates
    socket.emit("joinLobby", { roomCode, name: myName, themeCode });

    /* ---------------- UI events ---------------- */
    signOutBtn.onclick = () => window.location.href = "/player-login.html";
    endGameBtn.onclick = () => {
      if (confirm("Are you sure you want to end this game?")) {
        socket.emit("closeRoom", { roomCode });
      }
    };
    startBtn.onclick = () => {
      socket.emit("startRound", { roomCode, themeCode });
    };
    showQuestionBtn.onclick = () => {
      const promptText = document.getElementById("questionPrompt").innerText;
      document.getElementById("popupQuestion").innerText = escapeHTML(promptText);
      document.getElementById("roundPopup").style.display = "flex";
    };
    // Control switches enable/disable their features
    document.getElementById("toggleStart").addEventListener("change", e => {
      startBtn.disabled = !e.target.checked;
    });
    document.getElementById("toggleShow").addEventListener("change", e => {
      showBtn.disabled = !e.target.checked;
    });
    document.getElementById("toggleSubmit").addEventListener("change", e => {
      const on = e.target.checked;
      submitBtn.disabled = !on;
      inputBox.disabled = !on;
    });

    /* ---------------- Socket listeners (server ‚Üí client) ---------------- */
    // Room closed by host
    socket.on("roomClosed", () => {
      roomIsClosed = true;
      startBtn.disabled = true;
      showBtn.disabled = true;
      showQuestionBtn.disabled = true;
      submitBtn.disabled = true;
      inputBox.disabled = true;
      endGameBtn.disabled = true;
      document.getElementById("gameOverBanner").classList.remove("hidden");
      statusMessage.innerText = "üéÆ This game room has been closed.";
    });

    // Player list updates: renders active/inactive and submission status
    socket.on("playerList", data => {
      const players = data.players || data;
      const activeCount = data.activeCount || players.filter(p => p.active).length;
      const submittedCount = data.submittedCount || players.filter(p => p.active && p.submitted).length;

      const names = [...new Set(players.map(p => p.name))].sort((a,b)=>a.localeCompare(b));
      document.querySelector("#playersTable tbody").innerHTML = names.map(name => {
          const player = players.find(p => p.name === name);
          const ghost = player && player.active ? "" : "üëª"; // ghost icon if inactive
          const submitted = player ? (player.submitted ? "üü¢ Submitted" : "‚åõ Waiting") : "";
          return `<tr><td>${escapeHTML(name)}</td><td>${ghost}</td><td>${submitted}</td></tr>`;
        }).join("");

      // If QA section is visible, update progress
      if (document.getElementById("qaSection").style.display === "block") {
        document.getElementById("progress").innerText = `Submitted: ${escapeHTML(submittedCount)} / ${escapeHTML(activeCount)}`;
      }
    });

    // Submission progress: enables Show Answers when all active players submitted
    socket.on("submissionProgress", ({submittedCount,totalPlayers}) => {
      document.getElementById("progress").innerText = `Submitted: ${escapeHTML(submittedCount)} / ${escapeHTML(totalPlayers)}`;
      if (totalPlayers > 0 && submittedCount === totalPlayers) {
        showBtn.disabled = false;
        document.getElementById("toggleShow").checked = true;
      } else {
        showBtn.disabled = true;
        document.getElementById("toggleShow").checked = false;
      }
    });

    // Round started: sets up the UI for answering
    socket.on("roundStarted", ({questionId,prompt,playerCount,roundNumber,myAnswer,popup,theme}) => {
      currentRound = roundNumber;
      answersShown = false;

      // Disable controls until appropriate
      startBtn.disabled = true;
      document.getElementById("toggleStart").checked = false;
      showBtn.disabled = true;
      document.getElementById("toggleShow").checked = false;

      // Show QA section and prompt
      statusMessage.innerText = "Round in progress‚Ä¶";
      document.getElementById("qaSection").style.display = "block";
      openAccordion("questionBox");
      closeAccordion("answersTableWrapper");
      closeAccordion("pivotTableWrapper");
	  // Hide both answers and pivot accordions		
	  document.getElementById("answersAccordion").style.display="none";
	  document.getElementById("pivotAccordion").style.display="none";
	
      document.getElementById("questionPrompt").innerText = `Round ${roundNumber}: ${escapeHTML(prompt)}`;
      document.getElementById("progress").innerText = `Submitted: 0 / ${escapeHTML(playerCount)}`;

      // Open popup if room says popup active
      const promptText = document.getElementById("questionPrompt").innerText;
      document.getElementById("popupQuestion").innerText = escapeHTML(promptText);
      if (popup) document.getElementById("roundPopup").style.display = "flex";

      // Allow showing the question again via button
      showQuestionBtn.disabled = false;

      // Input handling: disable if already answered or answersShown
      if (answersShown || myAnswer) {
        submitBtn.disabled = true;
        inputBox.disabled = true;
        document.getElementById("toggleSubmit").checked = false;
        inputBox.value = myAnswer || "";
      } else {
        submitBtn.disabled = false;
        inputBox.disabled = false;
        document.getElementById("toggleSubmit").checked = true;
        inputBox.value = "";
        // Submit handler
        submitBtn.onclick = () => {
          const answer = inputBox.value.trim();
          if (!answer) return;
          socket.emit("submitAnswer", { roomCode, name: myName, questionId, answer });
          submitBtn.disabled = true;
          inputBox.disabled = true;
          document.getElementById("toggleSubmit").checked = false;
        };
      }
    });

    // Server signals all active players have submitted
    socket.on("allSubmitted", () => {
      showBtn.disabled = false;
      document.getElementById("toggleShow").checked = true;
    });

    // Show Answers button clicked
    showBtn.onclick = () => {
      socket.emit("showAnswers", { roomCode });
      answersShown = true;
    };

    // Answers revealed: render table and enable next round
    socket.on("answersRevealed", ({ rows, round, questionPrompt }) => {
      lastAnswers = rows;  // cache for Pivot awarding
      document.getElementById("roundNumber").textContent = round;
      document.getElementById("questionText").textContent = questionPrompt;

      const roundMap = toRoundMap(scoreboard, currentRound);
      document.querySelector("#answersTable tbody").innerHTML = rows.map(r => {
        const name = escapeHTML(r.name);
        const ans = escapeHTML(r.answer);
        const checked = roundMap[name] === 1 ? "checked" : "";
        const labelText = roundMap[name] === 1 ? "+1" : "0";
        const labelClass = roundMap[name] === 1 ? "pointLabel green" : "pointLabel blue";
        const isUnicorn = r.tag === "ü¶Ñ";

        return `
          <tr>
            <td>
              <label class="switch">
                <input type="checkbox" class="scoreToggle"
                       data-player="${name}" data-round="${currentRound}" ${checked}>
                <span class="slider"></span>
                <span class="${labelClass}">${labelText}</span>
              </label>
            </td>
            <td>
              <input type="radio" name="unicornTag" class="unicornRadio"
                     data-player="${name}" data-round="${currentRound}"
                     id="unicorn-${name}" ${isUnicorn ? "checked" : ""}>
              <label for="unicorn-${name}" class="unicornLabel"></label>
            </td>
            <td>${name}</td>
            <td>${ans}</td>
          </tr>
        `;
      }).join("");

      // Show answers accordion, hide question accordion
	  closeAccordion("questionBox");
      document.getElementById("answersAccordion").style.display="block";
      openAccordion("answersTableWrapper");
	  // ALSO show pivot accordion

	  // Default: build pivot counts locally (case-insensitive)
	  const counts = {};
	  rows.forEach(r => {
		const normalized = r.answer.trim().toLowerCase();
		counts[normalized] = (counts[normalized] || 0) + 1;
	  });

	// Render pivot rows into the table
	const pivotRows = Object.entries(counts).map(([answer, count]) => `
	  <tr>
	    <td><input type="checkbox" class="pivotCheckbox" data-answer="${escapeHTML(answer)}"></td>
	    <td>${count}</td>
	    <td>${escapeHTML(answer)}</td>
	  </tr>
	`).join("");
	
	document.querySelector("#pivotTable tbody").innerHTML = pivotRows;
	
	// Show pivot accordion
	document.getElementById("pivotAccordion").style.display = "block";
	openAccordion("pivotTableWrapper");

		
		
      // Reset button states for next round
      showBtn.disabled = true;
      document.getElementById("toggleShow").checked = false;
      startBtn.disabled = false;
      document.getElementById("toggleStart").checked = true;
      statusMessage.innerText = "Round finished. You can start a new round.";
    });

  // Fill the pivot table body
  socket.on("pivotUpdated", rows => {
  document.querySelector("#pivotTable tbody").innerHTML = rows.map(r => `
    <tr>
      <td><input type="checkbox" class="pivotCheckbox" data-answer="${escapeHTML(r.normalized_answer)}"></td>
      <td>${escapeHTML(r.player_count)}</td>
      <td>${escapeHTML(r.answer)}</td>
    </tr>
  `).join("");
});


document.getElementById("loadPivotBtn").addEventListener("click", () => {
  socket.emit("showAnswers", { roomCode }); // re-trigger server grouping
});


	  

    // Scoreboard updates: render and sync toggles and unicorns
    socket.on("scoreboardUpdated", data => {
      scoreboard = data || [];
      renderScoreboard(scoreboard);

      // Sync checkboxes in answers with latest points
      const roundMap = toRoundMap(scoreboard, currentRound);
      document.querySelectorAll(".scoreToggle").forEach(cb => {
        const player = cb.dataset.player;
        cb.checked = roundMap[player] === 1;
        const labelSpan = cb.closest("label").querySelector(".pointLabel");
        if (labelSpan) {
          labelSpan.textContent = cb.checked ? "+1" : "0";
          labelSpan.className = cb.checked ? "pointLabel green" : "pointLabel blue";
        }
      });
      // Sync unicorn radios
      document.querySelectorAll(".unicornRadio").forEach(radio => {
        const player = radio.dataset.player;
        radio.checked = scoreboard.find(p => p.player_name === player)?.tag === "ü¶Ñ";
      });
    });

    /* ---------------- Delegated event handlers (document-level) ---------------- */
    // Persist point toggles (+1/0) per player per round
    document.addEventListener("change", e => {
      if (e.target.classList.contains("scoreToggle")) {
        const player = e.target.dataset.player;
        const round = parseInt(e.target.dataset.round, 10);
        const points = e.target.checked ? 1 : 0;

        // Update label text and color immediately (optimistic UI)
        const labelSpan = e.target.closest("label").querySelector(".pointLabel");
        if (labelSpan) {
          labelSpan.textContent = points === 1 ? "+1" : "0";
          labelSpan.className = points === 1 ? "pointLabel green" : "pointLabel blue";
        }

        // Emit to server (awardPoint)
        socket.emit("awardPoint", { roomCode, playerName: player, roundNumber: round, points });
      }
    });

    // Unicorn assignment (atomic in server): clear old, set for selected player
    document.addEventListener("change", e => {
      if (e.target.classList.contains("unicornRadio")) {
        const player = e.target.dataset.player;
        socket.emit("setUnicorn", { roomCode, playerName: player });

        // Optimistic update: update scoreboard tags locally and rerender
        scoreboard.forEach(p => p.tag = "");
        const target = scoreboard.find(p => p.player_name === player);
        if (target) target.tag = "ü¶Ñ";
        renderScoreboard(scoreboard);
      }
    });

    // Pivot awarding: when a pivot checkbox is checked, award +1 to all who chose that answer
document.addEventListener("change", e => {
  if (e.target.classList.contains("pivotCheckbox")) {
    const normalizedAnswer = e.target.dataset.answer.toLowerCase();
    const checked = e.target.checked;

    // Find all players whose answer matches case-insensitively
    const matchingPlayers = lastAnswers.filter(
      r => r.answer.trim().toLowerCase() === normalizedAnswer
    );

    matchingPlayers.forEach(r => {
      const points = checked ? 1 : 0;
      socket.emit("awardPoint", {
        roomCode,
        playerName: r.name,
        roundNumber: currentRound,
        points
      });

      // Update answers table UI immediately
      const toggle = document.querySelector(`#answersTable input[data-player="${r.name}"]`);
      if (toggle) {
        toggle.checked = checked;
        const labelSpan = toggle.closest("label").querySelector(".pointLabel");
        if (labelSpan) {
          labelSpan.textContent = checked ? "+1" : "0";
          labelSpan.className = checked ? "pointLabel green" : "pointLabel blue";
        }
      }
    });
  }
});



    // Edit Scores toggle: allow manual editing of round cells (dropdowns)
    document.getElementById("editScoreboardBtn").addEventListener("click", () => {
      const selects = document.querySelectorAll(".scoreSelect");
      const isDisabled = selects[0]?.disabled;
      selects.forEach(sel => { sel.disabled = !isDisabled; });
      document.getElementById("editScoreboardBtn").textContent = isDisabled ? "Lock Scores" : "Edit Scores";
    });

    // Clear Unicorn button visibility and action
    const toggleUnicorn = document.getElementById("toggleUnicorn");
    const clearUnicornBtn = document.getElementById("clearUnicornBtn");
    toggleUnicorn.addEventListener("change", e => {
      clearUnicornBtn.style.display = e.target.checked ? "inline-block" : "none";
    });
    clearUnicornBtn.onclick = () => {
      if (confirm("Clear unicorn tag for this room?")) {
        // Optimistic: clear local scoreboard tags and radios
        scoreboard.forEach(p => p.tag = "");
        renderScoreboard(scoreboard);
        document.querySelectorAll(".unicornRadio").forEach(radio => { radio.checked = false; });
        // Note: server does not expose a clearUnicorn event; to clear on server,
        // host can set a new unicorn or we could add a route later.
      }
    };

    /* ---------------- Popup Logic ---------------- */
    document.getElementById("closePopup").onclick = () => {
      document.getElementById("roundPopup").style.display = "none";
    };
    document.getElementById("roundPopup").addEventListener("click", e => {
      if (e.target.id === "roundPopup") {
        document.getElementById("roundPopup").style.display = "none";
      }
    });
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        document.getElementById("roundPopup").style.display = "none";
      }
    });

    /* ---------------- Render Scoreboard ---------------- */
    function renderScoreboard(data) {
      // Determine max round to build columns
      const allRounds = data.flatMap(d =>
        Object.keys(d.rounds || {}).map(n => parseInt(n, 10))
      );
      const maxRound = Math.max(0, ...allRounds);

      // Header row: TAG, Player, Total, and round numbers
      const header =
        "<tr><th>TAG</th><th>Player</th><th>Total</th>" +
        Array.from({ length: maxRound }, (_, i) => `<th>#${i + 1}</th>`).join("") +
        "</tr>";
      document.querySelector("#scoreTable thead").innerHTML = header;

      // Player rows
      const rows = data
        .map(d => {
          const total = d.total || 0;
          const roundCells = Array.from({ length: maxRound }, (_, i) => {
            const rnum = i + 1;
            const val = (d.rounds && d.rounds[rnum]) != null ? d.rounds[rnum] : 0;
            return `
              <td class="roundCell">
                <select data-player="${escapeHTML(d.player_name)}" data-round="${rnum}" class="scoreSelect" disabled>
                  <option value="0" ${val == 0 ? "selected" : ""}>0</option>
                  <option value="1" ${val == 1 ? "selected" : ""}>1</option>
                </select>
              </td>
            `;
          }).join("");

          return `<tr><td>${d.tag === "ü¶Ñ" ? "ü¶Ñ" : ""}</td><td>${escapeHTML(d.player_name)}</td><td>${total}</td>${roundCells}</tr>`;
        })
        .join("");

      document.querySelector("#scoreTable tbody").innerHTML = rows;

      // Dynamic min-width so table scrolls if many rounds
      const baseWidth = 270; // Tag (40) + Player (150) + Total (80)
      const roundWidth = 55; // width for each round column
      const minWidth = baseWidth + (maxRound - 1) * roundWidth;
      document.querySelector("#scoreTable").style.minWidth = minWidth + "px";

      // Delegated change for dropdowns to award points (0/1) manually
      document.addEventListener("change", e => {
        if (e.target.classList.contains("scoreSelect")) {
          const player = e.target.dataset.player;
          const round = parseInt(e.target.dataset.round, 10);
          const points = parseInt(e.target.value, 10);
          socket.emit("awardPoint", { roomCode, playerName: player, roundNumber: round, points });
        }
      });
    }
  </script>
</body>
</html>

		













