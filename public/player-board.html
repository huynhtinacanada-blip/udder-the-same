<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player Dashboard ‚Äî Udderly the Same</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* Global Layout */
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      max-width:1200px;
      margin:40px auto;
      background:linear-gradient(135deg,#fdfcfb,#e2d1c3);
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.9);
    }

    /* Header */
    .header { display:flex; align-items:center; gap:12px; margin-bottom:20px;}
    .logo { max-width:100px; height:auto; display:block;}
    h2 { margin:0;}
    #statusMessage { font-weight:bold; margin-top:10px; text-align:center; color:#444;}

    /* Buttons */
    button {
      padding:10px 18px; margin:6px; font-size:16px; border:none; border-radius:8px;
      cursor:pointer; background:#333; color:#fff; transition:background 0.3s ease;
    }
    button:disabled { background:#999; cursor:not-allowed;}
    
    /* Default hover (orange) */
    button:hover:enabled { background:#F7AC4D; }

    /* Special End Game button hover */
    .danger-btn:hover:enabled { background:#d32f2f; color:#fff; font-weight:bold; }

    /* Show Question button hover */
    #showQuestionBtn:hover:enabled { background:#1976d2; }

    /* Show Answers button hover */
    #showAnswersBtn:hover:enabled { background:#2e7d32; }

    /* Accordion Sections */
    .accordion { margin-top:20px; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .accordion-header { background:#333; color:#fff; padding:12px; cursor:pointer; font-weight:bold;}
    .accordion-header:hover { background:#F7AC4D;}
    .accordion-content { max-height:0; overflow:hidden; transition:max-height 0.4s ease; background:#fff; padding:0 15px;}
    .accordion-content.open { padding:15px; max-height:1000px;}

    /* Tables */
    #answersTable, #playersTable, #scoreTable {
      font-size:18px; border-collapse:collapse; width:100%; margin-top:10px;
    }
    #answersTable th, #answersTable td,
    #playersTable th, #playersTable td,
    #scoreTable th, #scoreTable td {
      border-bottom:1px solid #ccc; padding:8px;
    }
    #answersTable th, #answersTable td { text-align:left; }

    /* Popup Modal */
    .popup {
      display:none;
      position:fixed;
      z-index:1000;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      justify-content:center;
      align-items:center;
    }
    .popup-content {
      background:#fff;
      border-radius:16px;
      padding:40px;
      width:80%; max-width:700px;
      text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
      animation:fadeIn 0.4s ease;
      position:relative;
    }
    .popup-content h1 { font-size:2rem; color:#333; margin:0; }
    .close-btn {
      position:absolute; top:20px; right:30px;
      font-size:32px; font-weight:bold;
      color:#333; cursor:pointer;
      transition:color 0.3s;
    }
    .close-btn:hover { color:#F7AC4D; }
    @keyframes fadeIn {
      from { transform:scale(0.9); opacity:0; }
      to   { transform:scale(1); opacity:1; }
    }

    /* --- Game Over Banner --- */
    #gameOverBanner {
      background-color: #d32f2f; color: white; font-weight: bold;
      text-align: center; padding: 25px; font-size: 22px;
      margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }

    /* Disclaimer Footer */
    .disclaimer { text-align:center; font-size:0.75em; color:#666; margin-top:50px; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <img src="udderly-logo-main-b.png" alt="Udderly the Same Logo" class="logo">
    <h2>üêÆ Player Dashboard <span class="small">(code ver. 1.1.0e)</span></h2>
    <button id="endGameBtn" class="danger-btn" style="margin-left:auto;">End Game</button>
  </div>

  <!-- --- Banner --- -->
  <div id="gameOverBanner" class="hidden">üéÆ Game Over</div>

  <!-- Accordion: Game Room Info -->
  <div class="accordion">
    <div class="accordion-header" onclick="toggleAccordion('questionBox')">Game Room Info</div>
    <div id="questionBox" class="accordion-content open">
      <div class="roomHeader">
        <p id="roomLabel"></p>
        <span id="topStatus"></span>
      </div>
      <table id="playersTable">
        <thead><tr><th>Player</th><th>Out</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="controls">
        <button id="startBtn">Start Round</button>
        <button id="showQuestionBtn" disabled>Show Question</button>
        <button id="showAnswersBtn" disabled>Show Answers</button>
        <p id="statusMessage"></p>
      </div>
      <div id="qaSection" style="display:none;">
        <p id="questionPrompt"></p>
        <textarea id="answerInput" rows="2" placeholder="Type your answer..."></textarea>
        <button id="submitAnswerBtn">Submit Answer</button>
        <p id="progress"></p>
      </div>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="roundPopup" class="popup">
    <div class="popup-content">
      <!-- ‚úÖ FIX: use consistent ID "closePopup" -->
      <span id="closePopup" class="close-btn">&times;</span>
      <h1 id="popupQuestion"></h1>
    </div>
  </div>

  <!-- Disclaimer Footer -->
  <div class="disclaimer">
    This online game is inspired by Herd Mentality, created by Big Potato Games. 
    It is an independent project and is not affiliated with, endorsed by, or sponsored by Big Potato Games.
  </div>

  <script>
    const urlParams=new URLSearchParams(window.location.search);
    const roomCode=(urlParams.get("room")||"").toUpperCase();
    const myName=urlParams.get("name")||"";
    document.getElementById("roomLabel").innerText=`Room: ${roomCode} ‚Äî You: ${myName}`;
    const socket=io();
    socket.emit("joinLobby",{roomCode,name:myName});

    const startBtn=document.getElementById("startBtn");
    const showBtn=document.getElementById("showAnswersBtn");
    const showQuestionBtn=document.getElementById("showQuestionBtn");
    const statusMsg=document.getElementById("statusMessage");
    const submitBtn=document.getElementById("submitAnswerBtn");
    const inputBox=document.getElementById("answerInput");

    // ... other setup code omitted for brevity ...

    socket.on("roundStarted", ({questionId, prompt, playerCount, roundNumber, myAnswer, popup}) => {
      currentRound = roundNumber;
      answersShown = false;

      // Reset controls
      startBtn.disabled = true;
      document.getElementById("toggleStart").checked = false;
      showBtn.disabled = true;
      document.getElementById("toggleShow").checked = false;

      statusMsg.innerText = "Round in progress‚Ä¶";
      document.getElementById("qaSection").style.display = "block";
      openAccordion("questionBox");
      closeAccordion("answersTableWrapper");
      document.getElementById("answersAccordion").style.display = "none";
      document.getElementById("questionPrompt").innerText = `Round ${roundNumber}: ${prompt}`;
      document.getElementById("progress").innerText = `Submitted: 0 / ${playerCount}`;

      // Only auto-show popup if server says popup=true
      if (popup) {
        document.getElementById("popupQuestion").innerText = `Round ${roundNumber}: ${prompt}`;
        document.getElementById("roundPopup").style.display = "flex";
      }

      // Keep local toggle enabled at all times
      showQuestionBtn.disabled = false;

      // Answer submission logic
      if (answersShown || myAnswer) {
        submitBtn.disabled = true;
        inputBox.disabled = true;
        document.getElementById("toggleSubmit").checked = false;
        inputBox.value = myAnswer || "";
      } else {
        submitBtn.disabled = false;
        inputBox.disabled = false;
        document.getElementById("toggleSubmit").checked = true;
        inputBox.value = "";
        submitBtn.onclick = () => {
          const answer = inputBox.value.trim();
          if (!answer) return;
          socket.emit("submitAnswer", { roomCode, name: myName, questionId, answer });
          submitBtn.disabled = true;
          inputBox.disabled = true;
          document.getElementById("toggleSubmit").checked = false;
        };
      }
    });

    socket.on("allSubmitted", () => {
      showBtn.disabled = false;
      document.getElementById("toggleShow").checked = true;
    });

    showBtn.onclick = () => {
      socket.emit("showAnswers", { roomCode });
      answersShown = true;
    };

    // ‚ùå DELETE: old close handler that only hid popup
    // document.getElementById("closePopup").onclick = () => {
    //   document.getElementById("roundPopup").style.display = "none";
    // };

    // ‚úÖ ADD: new close handler that hides popup AND tells server
    document.getElementById("closePopup").onclick = () => {
      document.getElementById("roundPopup").style.display = "none";
      socket.emit("dismissPopup", { roomCode });  // notify server popup dismissed
    };

    // Backdrop click handler (keep as is)
    document.getElementById("roundPopup").addEventListener("click", e => {
      if (e.target.id === "roundPopup") {
        document.getElementById("roundPopup").style.display = "none";
      }
    });

    showQuestionBtn.onclick = () => {
      // Copy the current question prompt into the popup
      const promptText = document.getElementById("questionPrompt").innerText;
      document.getElementById("popupQuestion").innerText = promptText;

      // Show the popup again
      document.getElementById("roundPopup").style.display = "flex";
    };

    socket.on("answersRevealed", rows => {
      const roundMap = toRoundMap(scoreboard, currentRound);
      document.querySelector("#answersTable tbody").innerHTML = rows
        .map(r => {
          const name = escapeHTML(r.name);
          const ans = escapeHTML(r.answer);
          const checked = roundMap[name] === 1 ? "checked" : "";
          const labelText = roundMap[name] === 1 ? "+1" : "0";
          const labelClass = roundMap[name] === 1 ? "pointLabel green" : "pointLabel blue";
          return `
            <tr>
              <td>
                <label class="switch">
                  <input type="checkbox" class="scoreToggle" data-player="${name}" data-round="${currentRound}" ${checked}>
                  <span class="slider"></span>
                  <span class="${labelClass}">${labelText}</span>
                </label>
              </td>
              <td>${name}</td>
              <td>${ans}</td>
            </tr>
          `;
        })
        .join("");

      document.getElementById("answersAccordion").style.display="block";
      openAccordion("answersTableWrapper");
      closeAccordion("questionBox");
      showBtn.disabled=true;
      document.getElementById("toggleShow").checked = false;
      startBtn.disabled=false;
      document.getElementById("toggleStart").checked = true;
      statusMsg.innerText="Round finished. You can start a new round.";
    });

    // Persist point toggles
    document.addEventListener("change", e => {
      if (e.target.classList.contains("scoreToggle")) {
        const player = e.target.dataset.player;
        const round = parseInt(e.target.dataset.round, 10);
        const points = e.target.checked ? 1 : 0;
        socket.emit("awardPoint", { roomCode, playerName: player, roundNumber: round, points });

        const labelSpan = e.target.closest("label").querySelector(".pointLabel");
        if (labelSpan) {
          labelSpan.textContent = points === 1 ? "+1" : "0";
          labelSpan.className = points === 1 ? "pointLabel green" : "pointLabel blue";
        }
      }
    });

    socket.on("scoreboardUpdated", data => {
      scoreboard = data || [];
      renderScoreboard(scoreboard);
      if (document.getElementById("answersAccordion").style.display === "block") {
        const roundMap = toRoundMap(scoreboard, currentRound);
        document.querySelectorAll(".scoreToggle").forEach(cb => {
          const player = cb.dataset.player;
          cb.checked = roundMap[player] === 1;
          const labelSpan = cb.closest("label").querySelector(".pointLabel");
          if (labelSpan) {
            labelSpan.textContent = cb.checked ? "+1" : "0";
            labelSpan.className = cb.checked ? "pointLabel green" : "pointLabel blue";
          }
        });
      }
    });

    // Render scoreboard with dropdowns
    function renderScoreboard(data) {
      const allRounds = data.flatMap(d => Object.keys(d.rounds || {}).map(n => parseInt(n, 10)));
      const maxRound = Math.max(0, ...allRounds);

      const header = "<tr><th>Player</th><th>Total</th>" +
        Array.from({length: maxRound}, (_, i) => `<th>#${i+1}</th>`).join("") +
        "</tr>";
      document.querySelector("#scoreTable thead").innerHTML = header;

      const rows = data.map(d => {
        const total = d.total || 0;
        const roundCells = Array.from({length: maxRound}, (_, i) => {
          const rnum = i + 1;
          const val = (d.rounds && d.rounds[rnum]) != null ? d.rounds[rnum] : 0;
          return `
            <td class="roundCell">
              <select data-player="${escapeHTML(d.player_name)}" data-round="${rnum}" class="scoreSelect">
                <option value="0" ${val == 0 ? "selected" : ""}>0</option>
                <option value="1" ${val == 1 ? "selected" : ""}>1</option>
              </select>
            </td>
          `;
        }).join("");
        return `<tr><td>${escapeHTML(d.player_name)}</td><td>${total}</td>${roundCells}</tr>`;
      }).join("");

      document.querySelector("#scoreTable tbody").innerHTML = rows;

      // Auto-persist dropdown changes
      document.querySelectorAll(".scoreSelect").forEach(select => {
        select.addEventListener("change", e => {
          const player = e.target.dataset.player;
          const round = parseInt(e.target.dataset.round, 10);
          const points = parseInt(e.target.value, 10);
          socket.emit("awardPoint", { roomCode, playerName: player, roundNumber: round, points });
        });
      });
    }

    function toRoundMap(data, round) {
      const map = {};
      (data || []).forEach(d => {
        const val = (d.rounds && d.rounds[round]) != null ? d.rounds[round] : 0;
        map[escapeHTML(d.player_name)] = parseInt(val, 10) === 1 ? 1 : 0;
      });
      return map;
    }

    function escapeHTML(str){
      const div=document.createElement('div');
      div.innerText=String(str||"");
      return div.innerHTML;
    }
    function toggleAccordion(id){document.getElementById(id).classList.toggle("open");}
    function openAccordion(id){document.getElementById(id).classList.add("open");}
    function closeAccordion(id){document.getElementById(id).classList.remove("open");}
  </script>
</body>
</html>


 
