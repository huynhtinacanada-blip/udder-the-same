<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cards ‚Äî Udderly the Same</title>
  <style>
    /*        Global Layout     */
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      max-width: 900px; 
      margin: 40px auto; 
      background: #f9f9f9; 
    }
    h1 { 
      text-align: center; 
      margin-bottom: 20px; 
    }

    /*        Form Inputs & Buttons     */
    input, button, textarea { 
      font-size: 16px; 
      padding: 8px; 
      margin: 6px 0; 
    }
    .btn { 
      background: #333; 
      color: #fff; 
      padding: 8px 12px; 
      border-radius: 6px; 
      text-decoration: none; 
      display: inline-block; 
      margin-bottom: 16px; 
    }
    .btn:hover { background: #F7AC4D; }

    /*        Question Input Row     */
    .question-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    #questionText { 
      flex: 1;              /* textarea expands to fill available space */
      min-height: 40px;     /* minimum height */
      resize: vertical;     /* allow vertical resizing */
    }
    #addBtn { flex-shrink: 0; }

    /* Clear Discard Button */
    .clear-btn {
      background: #c62828;
    }
    .clear-btn:hover {
      background: #e53935;
    }

    /*        Table Styling     */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 12px; 
      background: #fff; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 8px; 
      text-align: left; 
    }
    th { background: #eee; }

    /*        Action Buttons (Edit/Delete)     */
    .action-btn { 
      font-size: 14px; 
      padding: 4px 8px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .edit-btn { background: #2e7d32; color: #fff; }
    .edit-btn:hover { background: #388e3c; }
    .delete-btn { background: #c62828; color: #fff; }
    .delete-btn:hover { background: #e53935; }
    .actions { display: flex; gap: 8px; }

    /*        Header & Logo     */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .logo {
      max-width: 100px;
      height: auto;
      display: block;
    }

    /*        Footer     */
    .bottom-bar { 
      margin-top: 30px; 
      text-align: center; 
    }

    /*        Scroll-to-Top Button     */
    .table-wrapper {
      position: relative; /* anchor for absolute positioning */
    }

#scrollTopBtn {
  position: fixed;
  top: 50%;              /* halfway down the viewport */
//  right: 30px;          
  /* keep it near the right edge */
    left: calc(50% + 450px);   /* aligns to the right of a 900px table centered on pag
  transform: translateY(-50%); /* perfectly center vertically */
  display: none;
  background-color: #333;
  cursor: pointer;
  padding: 5px;
  border-radius: 20%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 999;
}

#scrollTopBtn img {
  width: 36px;
  height: 36px;
  display: block;
  margin: auto;
}

#scrollTopBtn:hover {
  background-color: #fff;
}

  </style>
</head>
<body>
  <!--        Header with Logo and Title   -->
  <div class="header">
    <img src="udderly-logo-admin.png" alt="Udderly the Same Logo" class="logo">
    <h1>üìá Card Management</h1>
  </div>

  <!-- Navigation and Clear Discard -->
  <a class="btn" href="/admin-dashboard.html">‚Üê Back to Dashboard</a>
  <button id="clearDiscardBtn" class="btn clear-btn">Clear Discard: All</button>

  <!--        Question Input Row, Textarea + Add/Update Button   -->
  <div class="question-row">
    <textarea id="questionText" placeholder="New question text"></textarea>
    <button id="addBtn">Add Question</button>
  </div>

  <!--        Table of Cards   -->
  <div class="table-wrapper">
    <table id="cardsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Question Card</th>
          <th>Discard</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Footer Navigation -->
    <div class="bottom-bar">
      <a class="btn" href="/admin-dashboard.html">‚Üê Back to Dashboard</a>
    </div>
    <div style="text-align:center; font-size:0.8em; color:gray; margin-top:10px;">
      üìá Card Management Ver. 1.0.1r
    </div>

    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn">
      <img src="top.png" alt="Scroll to top">
    </button>
  </div>

  <!--        JavaScript Logic   -->
  <script>
    // Tracks which question is being edited (null if adding new)
    let editingId = null;

    /**
     * loadQuestions()
     * Fetches all questions from the backend API (/api/questions),
     * then populates the table body with rows for each question.
     * Each row includes: ID, prompt text, discard date, and action buttons.
     */
    async function loadQuestions() {
      const res = await fetch('/api/questions');
      const qs = await res.json();

      document.querySelector('#cardsTable tbody').innerHTML = qs.map(q =>
        `<tr>
          <td>${q.id}</td>
          <td>${escapeHTML(q.prompt)}</td>
          <td>${formatDiscardDate(q.discard)}</td>
          <td>
            <div class="actions">
              <button class="action-btn edit-btn" onclick="editQuestion(${q.id}, '${escapeHTML(q.prompt)}')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteQuestion(${q.id})">Delete</button>
            </div>
          </td>
        </tr>`
      ).join('');
    }

    /**
     * formatDiscardDate(discard)
     * Converts discard date into YYYY-DD-MM format.
     * - If no date: returns blank.
     * - If invalid date: returns raw value.
     */
    function formatDiscardDate(discard) {
      if (!discard) return ""; 
      const d = new Date(discard);
      if (isNaN(d)) return discard; 
      const yyyy = d.getFullYear();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${yyyy}-${dd}-${mm}`;
    }

    /**
     * Add/Update Button Click Handler
     * - If editingId is set: updates existing question (PUT request).
     * - Otherwise: adds new question (POST request).
     * After success, reloads the table and resets form.
     */
    document.getElementById('addBtn').onclick = async () => {
      const text = document.getElementById('questionText').value.trim();
      if (!text) return alert('Enter a question');

      if (editingId) {
        // Update existing question
        const res = await fetch(`/api/questions/${editingId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) {
          editingId = null;
          document.getElementById('questionText').value = '';
          document.getElementById('addBtn').textContent = 'Add Question';
          loadQuestions();
        } else {
          alert('Failed to update question');
        }
      } else {
        // Add new question
        const res = await fetch('/api/questions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) {
          // Clear input after successful add
          document.getElementById('questionText').value = '';
          loadQuestions(); // Refresh table
        } else {
          alert('Failed to add question');
        }
      }
    };

    /**
     * editQuestion(id, text)
     * Called when user clicks "Edit".
     * - Loads the selected question text into the textarea.
     * - Sets editingId so the next submit updates instead of adding.
     * - Changes button label to "Update Question".
     */
    function editQuestion(id, text) {
      document.getElementById('questionText').value = text;
      editingId = id;
      document.getElementById('addBtn').textContent = 'Update Question';
    }

    /**
     * deleteQuestion(id)
     * Called when user clicks "Delete".
     * - Confirms with user.
     * - Sends DELETE request to backend.
     * - Reloads table if successful.
     */
    async function deleteQuestion(id) {
      if (!confirm('Are you sure you want to delete this question?')) return;
      const res = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
      if (res.ok) {
        loadQuestions();
      } else {
        alert('Failed to delete question');
      }
    }

    /**
     * escapeHTML(str)
     * Utility function to sanitize user input/output.
     * Prevents HTML injection by converting text into safe HTML entities.
     */
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.innerText = String(str || "");
      return div.innerHTML;
    }

    // Initial load of questions when page opens
    loadQuestions();

    /* ------------------------------
       Scroll-to-Top Button Logic
       - Shows button when user scrolls down 200px.
       - Smoothly scrolls back to top when clicked.
    ------------------------------ */
    const scrollBtn = document.getElementById("scrollTopBtn");

    window.addEventListener("scroll", () => {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        scrollBtn.style.display = "block";
      } else {
        scrollBtn.style.display = "none";
      }
    });

    scrollBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>


