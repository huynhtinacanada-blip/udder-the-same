<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cards ‚Äî Udderly the Same</title>
  <style>
    /* ---- Global layout ---- */
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      max-width: 900px; 
      margin: 40px auto; 
      background: #f9f9f9; 
    }
    h1 { text-align: center; margin-bottom: 20px; }

    /* ---- Header & logo ---- */
    .header { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 20px; 
    }
    .logo { max-width: 100px; height: auto; display: block; }

    /* ---- Navigation buttons ---- */
    .btn { 
      background: #333; 
      color: #fff; 
      padding: 8px 12px; 
      border-radius: 6px; 
      text-decoration: none; 
      display: inline-block; 
      margin-bottom: 16px; 
    }
    .btn:hover { background: #F7AC4D; }
    .clear-btn { background: #c62828; }
    .clear-btn:hover { background: #e53935; }

    /* ---- Question input row ---- */
    .question-row { display: flex; align-items: flex-start; gap: 10px; }
    #questionText { flex: 1; min-height: 40px; resize: vertical; }
    #addBtn { flex-shrink: 0; }

    /* ---- Sticky top section ----
       - position: sticky keeps header + controls visible while scrolling
       - top: 0 anchors it to the top of viewport
       - z-index: 1000 ensures it stays above table content
       - background: inherit so it doesn‚Äôt overlap with transparent background
       NOTE: `top: 0` means the .top-section is pinned at the very top of the viewport.
       It does NOT mean the .top-section has zero height ‚Äî it simply starts at the top edge
       of the screen and keeps its full height visible while scrolling. */
    .top-section {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #f9f9f9;
      padding-bottom: 10px; /* small gap below sticky area */
    }

    /* ---- Accordion ----
       - toggle button shows/hides table
       - content expands/collapses smoothly */
    .accordion { margin-top: 20px; }

    .accordion-toggle {
      background: #333;
      color: #fff;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      text-align: left;
    }

    .accordion-toggle:hover { background: #F7AC4D; }

    .accordion-content {
      max-height: 0;              /* collapsed by default */
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.open {
      max-height: 600px;          /* enough space for table scroll */
    }
      
    /* ---- Table styling ----
       includes extra spacing before header */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 14px; /* breathing room below sticky section */
      background: #fff; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
  
    /* ---- Table cells ----
       - border for separation
       - padding for readability
       - left alignment for text */
    th, td { 
      border: 1px solid #ccc; 
      padding: 8px; 
      text-align: left; 
    }
  
    /* ---- Table header background ---- */
    th { 
      background: #eee; 
    }
  
    /* ---- Sticky table headers ----
       - position: sticky keeps header row visible while scrolling
       - top: adjust to height of sticky top-section so headers sit just below it
       - already have a sticky .top-section (logo, buttons, input bar) at the very top of the page.
       If that section is, say, 100px tall, then setting top: 100px makes the table header stick
       just below it, without overlapping the top-section. Adjust this value to match the actual
       height of your .top-section so the header aligns correctly.
       - z-index: 2 keeps headers above table rows */
    thead th { 
      position: sticky; 
      top: 120px; /* adjust this to match your .top-section height */
      background: #eee;  /* it prevents the header from blending with rows when sticky */
      z-index: 2; /* higher priority, appears above box1 */
    }
  
    /* ---- Checkbox column ----
       - centers checkboxes
       - fixed width for consistency */
    td:first-child, th:first-child {
      text-align: center;
      width: 40px;
    }
  
    /* ---- Modern checkbox styling ----
       - removes default browser style
       - adds rounded corners, hover, and checkmark */
    .modern-checkbox {
      appearance: none;        /* remove default browser style */
      width: 18px;
      height: 18px;
      border: 2px solid #555;
      border-radius: 4px;      /* rounded corners */
      background-color: #fff;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }
  
    /* ---- Hover effect ---- */
    .modern-checkbox:hover {
      border-color: #0078d4;   /* accent blue */
    }
  
    /* ---- Checked state ---- */
    .modern-checkbox:checked {
      background-color: #0078d4;
      border-color: #0078d4;
    }
  
    /* ---- Checkmark pseudo-element ----
       - adds a white ‚úî symbol inside when checked */
    .modern-checkbox:checked::after {
      content: "‚úî";
      color: #fff;
      font-size: 14px;
      position: absolute;
      top: -2px;
      left: 2px;
    }

    /* ---- Action buttons inside table ---- */
    .action-btn { font-size: 14px; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .edit-btn { background: #2e7d32; color: #fff; }
    .edit-btn:hover { background: #388e3c; }
    .delete-btn { background: #c62828; color: #fff; }
    .delete-btn:hover { background: #e53935; }
    .actions { display: flex; gap: 8px; }

    /* ---- Footer ---- */
    .bottom-bar { margin-top: 30px; text-align: center; }

    /* ---- Table wrapper ----
       position: relative ensures absolutely positioned children
       (like overlays/buttons) are anchored here.
       For sticky headers to work, the parent must allow scrolling. 
       Overflow-y: auto.
       max-height + overflow-y makes table scrollable so sticky headers work */
    .table-wrapper { 
      position: relative; 
      max-height: 500px;   /* set scrollable height */
      overflow-y: auto;    /* enable vertical scroll */
    }

    /* ---- Scroll-to-top button ----
       fixed positioning keeps visible while scrolling
       top: 50% centers vertically
       left: calc(50% + 475px) aligns to right of centered 900px table
       transform: translateY(-50%) perfect vertical centering
       z-index: 999 ensures button stays above other elements */
    #scrollTopBtn {
      position: fixed;
      top: 50%;
      left: calc(50% + 475px);
      transform: translateY(-50%);
      display: none; /* hidden until scroll threshold reached */
      background-color: #333;
      cursor: pointer;
      padding: 5px;
      border-radius: 20%; /* rounded button shape */
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); /* subtle shadow */
      z-index: 999;
    }
    #scrollTopBtn img { width: 36px; height: 36px; display: block; margin: auto; }
    #scrollTopBtn:hover { background-color: #fff; }

    /* ---- Responsive adjustments ----
       For screens smaller than 600px:
       - reduce margins
       - stack header vertically
       - move scroll button to bottom-right */
    @media (max-width: 600px) {
      body { margin: 20px; max-width: 100%; }
      .header { flex-direction: column; text-align: center; }
      #scrollTopBtn { left: auto; right: 20px; top: auto; bottom: 20px; transform: none; }
    }
  </style>
</head>
<body>
  <!-- ---- Sticky top section ---- -->
  <div class="top-section">
    <!-- ---- Header section ---- -->
    <div class="header">
       <img src="udderly-logo-admin.png" alt="Udderly the Same Logo" class="logo">
      <h1>üìá Card Management</h1>
    </div>
  
    <!-- ---- Navigation and clear button ---- -->
    <a class="btn" href="/admin-dashboard.html">‚Üê Back to Dashboard</a>
    <button id="clearDiscardBtn" class="btn clear-btn">Clear Discard: All</button>
  
    <!-- ---- Question input ---- -->
    <div class="question-row">
      <textarea id="questionText" placeholder="New question text"></textarea>
      <button id="addBtn">Add Question</button>
    </div>
  </div>
    
  <!-- ---- Accordion for table section ---- -->
  <div class="accordion">
    <button class="accordion-toggle">‚ñº Show Questions Table</button>
    <div class="accordion-content">
      <div class="table-wrapper">
        <table id="cardsTable">
          <thead>
            <tr>
              <!-- Checkbox column header (master checkbox to select/deselect all rows) -->
              <th scope="col">
                <input type="checkbox" id="selectAll" class="modern-checkbox">
              </th>
              <th scope="col">ID</th>
              <th scope="col">Question Card</th>
              <th scope="col">Discard</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ---- Footer navigation ---- -->
  <div class="bottom-bar">
    <a class="btn" href="/admin-dashboard.html">‚Üê Back to Dashboard</a>
  </div>
  
  <!-- ---- Version info ---- -->
  <div style="text-align:center; font-size:0.8em; color:gray; margin-top:10px;">
    üìá Card Management Ver. 1.0.4r
  </div>
  
  <!-- ---- Scroll-to-top button ---- -->
  <button id="scrollTopBtn">
    <img src="top.png" alt="Scroll to top">
  </button>

  <script>
    /* ---- State management ----
       editingId tracks which question is being edited
       null means adding new
       set to ID when editing existing */
    let editingId = null;

    /* ---- Load questions from backend ----
       - Fetch /api/questions
       - Populate table rows dynamically
       - Escape HTML to prevent injection */
    async function loadQuestions() {
      try {
        const res = await fetch('/api/questions');
        if (!res.ok) throw new Error('Failed to load questions');
        const qs = await res.json();

        document.querySelector('#cardsTable tbody').innerHTML = qs.map(q =>
          `<tr>
             <!-- row checkbox column -->
            <td><input type="checkbox" class="row-select modern-checkbox"></td>
            <td>${q.id}</td>
            <td>${escapeHTML(q.prompt)}</td>
            <td>${formatDiscardDate(q.discard)}</td>
            <td>
              <div class="actions">
                <button class="action-btn edit-btn" 
                        data-id="${q.id}" 
                        data-text="${escapeHTML(q.prompt)}"
                        onclick="editQuestion(this.dataset.id, this.dataset.text)">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteQuestion(${q.id})">Delete</button>
              </div>
            </td>
          </tr>`
        ).join('');
      } catch (err) {
        alert(err.message);
      }
    }

    /* ---- Format discard date ----
       Converts date to YYYY-MM-DD format */
    function formatDiscardDate(discard) {
      if (!discard) return ""; 
      const d = new Date(discard);
      if (isNaN(d)) return discard; 
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    /* ---- Add/Update button handler ----
       - If editingId set: PUT update
       - Else: POST new question
       - Reload table on success */
    document.getElementById('addBtn').onclick = async () => {
      const text = document.getElementById('questionText').value.trim();
      if (!text) return alert('Enter a question');

      try {
        if (editingId) {
          // ---- Update existing question ----
          const res = await fetch(`/api/questions/${editingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });
          if (res.ok) {
            editingId = null; // reset editing state
            document.getElementById('questionText').value = '';
            document.getElementById('addBtn').textContent = 'Add Question';
            loadQuestions(); // refresh table
          } else {
            alert('Failed to update question');
          }
        } else {
          // ---- Add new question ----
          const res = await fetch('/api/questions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }) // send new question text to backend
          });
          if (res.ok) {
            document.getElementById('questionText').value = ''; // clear input
            loadQuestions(); // refresh table
          } else {
            alert('Failed to add question');
          }
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    /* ---- Edit question ----
       - Load text into textarea
       - Set editingId
       - Change button label to "Update Question" */
    function editQuestion(id, text) {
      document.getElementById('questionText').value = text;
      editingId = id;
      document.getElementById('addBtn').textContent = 'Update Question';
    }

    /* ---- Delete question ----
       - Confirm with user
       - Send DELETE request
       - Reload table on success */
    async function deleteQuestion(id) {
      if (!confirm('Are you sure you want to delete this question?')) return;
      try {
        const res = await fetch(`/api/questions/${id}`, { method: 'DELETE' });
        if (res.ok) {
          // if the deleted item was being edited, reset editing state
          if (editingId == id) {
            editingId = null;
            document.getElementById('questionText').value = '';
            document.getElementById('addBtn').textContent = 'Add Question';
          }
          loadQuestions();
        } else {
          alert('Failed to delete question');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    /* ---- Escape HTML ----
       Prevents injection attacks by converting special characters */
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.innerText = String(str || "");
      return div.innerHTML;
    }

    // ---- Initial load of questions when page opens ----
    loadQuestions();

    /* ---- Scroll-to-top button logic ----
       - Show button when user scrolls down 200px
       - Hide button near top
       - Smooth scroll back to top on click */
    const scrollBtn = document.getElementById("scrollTopBtn");

    window.addEventListener("scroll", () => {
      // check both body and documentElement for cross-browser support
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        scrollBtn.style.display = "block"; // show button
      } else {
        scrollBtn.style.display = "none"; // hide button
      }
    });

    scrollBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: 'smooth' }); // smooth scroll to top
    });

    /* ---- Select all checkboxes logic ----
       - Placed AFTER scroll-to-top because:
         1. DOM timing: ensures table rows exist before attaching listeners.
         2. Organization: keeps table-related logic grouped together, separate from scroll feature. */
    document.getElementById('selectAll').addEventListener('change', function() {
      const checked = this.checked;
      document.querySelectorAll('.row-select').forEach(cb => cb.checked = checked);
    });

    /* ---- Sync master checkbox with row checkboxes ----
       - If any row is unchecked, master unchecks.
       - If all rows are checked, master checks itself. */
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('row-select')) {
        const allChecked = [...document.querySelectorAll('.row-select')].every(cb => cb.checked);
        document.getElementById('selectAll').checked = allChecked;
      }
    });

    /* ---- Accordion toggle ----
       - Expands/collapses table section
       - Updates button text accordingly */
    document.querySelector('.accordion-toggle').addEventListener('click', function() {
      const content = document.querySelector('.accordion-content');
      content.classList.toggle('open');
      this.textContent = content.classList.contains('open')
        ? '‚ñ≤ Hide Questions Table'
        : '‚ñº Show Questions Table';
    });
  </script>
</body>
</html>
